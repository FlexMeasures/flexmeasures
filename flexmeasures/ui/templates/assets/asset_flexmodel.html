{% extends "base.html" %}

{% set active_page = "assets" %}

{% block title %} {{ asset.name }} - Scenario {% endblock %}

{% block divs %}

{% block breadcrumbs %} {{ super() }} {% endblock %}



<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 on-top-md">

        </div>

        <div class="col-md-8">
            <div class="row mt-3">
                <!-- Left Column -->
                <div class="col-5">
                    <div id="flexmodelContainer">
                    </div>
                </div>

                <!-- Right Column -->
                <div class="col-7">
                    <div class="">
                        <!-- Loading Spinner -->
                        <div id="spinnerElement" class="d-flex justify-content-center align-items-center mb-2"
                            style="height: 50vh; display: none !important;">
                            <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div>
                            <div class="row">
                                <div class="col-10">
                                    <select class="form-select" id="flexSelect">
                                        <option value="blank">Select flex-model field to add</option>
                                    </select>
                                </div>
                                <div class="col-2 p-0">
                                    <button class="btn btn-secondary btn-md" onclick="addFlexModelField()">Add
                                        Field</button>
                                </div>
                            </div>

                            <div id="flexInfoContainer" class="mt-3"></div>
                        </div>

                        <hr class="border border-dark" />

                        <div id="flexOptionsContainer" class="mt-3"></div>

                        <div id="sensorsSearchResults" class="row mt-3" style="display: none;"></div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-md-2">

        </div>
    </div>
</div>

<script>
    const apiBasePath = window.location.origin;
    const typeOne = [Boolean];
    const typeTwo = [Object];
    const typeThree = [String, Object];
    const typeFour = [Array];

    const assetFlexModelSchema = {
        "soc-min": null,
        "soc-max": null,
        "soc-minima": null,
        "soc-maxima": null,
        "soc-targets": null,
        "state-of-charge": null,
        "soc-gain": [],
        "soc-usage": [],
        "roundtrip-efficiency": null,
        "charging-efficiency": null,
        "discharging-efficiency": null,
        "storage-efficiency": null,
        "prefer-charging-sooner": null,
        "prefer-curtailing-later": null,
        "power-capacity": null,
        "consumption-capacity": null,
        "production-capacity": null,
    }

    const FlexModelFieldValidTypes = {
        "soc-min": typeThree,
        "soc-max": typeThree,
        "soc-minima": typeTwo,
        "soc-maxima": typeTwo,
        "soc-targets": typeTwo,
        "state-of-charge": typeOne,
        "soc-gain": typeFour,
        "soc-usage": typeFour,
        "roundtrip-efficiency": typeThree,
        "charging-efficiency": typeThree,
        "discharging-efficiency": typeThree,
        "storage-efficiency": typeThree,
        "prefer-charging-sooner": typeOne,
        "prefer-curtailing-later": typeOne,
        "power-capacity": typeThree,
        "consumption-capacity": typeThree,
        "production-capacity": typeThree,
    };

    const assetFlexModelFieldDesc = {
        "soc-min": "A constant lower boundary for all values in the schedule (defaults to 0).",
        "soc-max": null,
        "soc-minima": null,
        "soc-maxima": null,
        "soc-targets": null,
        "state-of-charge": null,
        "soc-gain": [],
        "soc-usage": [],
        "roundtrip-efficiency": null,
        "charging-efficiency": null,
        "discharging-efficiency": null,
        "storage-efficiency": null,
        "prefer-charging-sooner": "Tie-breaking policy to apply if conditions are stable, which signals a preference to charge sooner rather than later (defaults to True). It also signals a preference to discharge later. Boolean option only.",
        "prefer-curtailing-later": null,
        "power-capacity": null,
        "consumption-capacity": null,
        "production-capacity": null,
    }

    /**
    * A custom function to mimic React's useState for simple DOM manipulation.
    *
    * @param {*} initialValue - The initial value for the state.
    * @param {function(value: *): void} renderFunction - A callback function that
    * will be executed whenever the state updates. This function should contain
    * the logic to update the relevant DOM elements. It receives the new state value.
    * @returns {[function(): *, function(*): void]} - A tuple/array containing:
    * - A getter function for the current state value (to be reactive, we need a function).
    * - A setter function to update the state value, which also triggers the renderFunction.
    */
    function createReactiveState(initialValue, renderFunction) {
        let value = initialValue;

        // The function that returns the current state value
        function getValue() {
            return value;
        }

        // The function that updates the state value
        function setValue(newValue) {
            if (typeof newValue === 'function') {
                value = newValue(value);
            } else {
                value = newValue;
            }
            if (renderFunction) {
                renderFunction(value);
            }
        }

        if (renderFunction) {
            renderFunction(value);
        }

        return [getValue, setValue];
    }

    document.addEventListener('DOMContentLoaded', async function () {
        let assetFlexModelRawJSON = '{{ asset_flexmodel | safe}}';
        assetFlexModelRawJSON = Object.assign({}, assetFlexModelSchema, processResourceRawJSON(assetFlexModelSchema, assetFlexModelRawJSON));

        const flexOptionsContainer = document.getElementById('flexOptionsContainer');
        const flexmodelContainer = document.getElementById('flexmodelContainer');
        const flexInfoContainer = document.getElementById('flexInfoContainer');
        const [getFlexModel, setFlexModel] = createReactiveState(assetFlexModelRawJSON);
        const [activeCard, setActiveCard] = createReactiveState(null);


        async function updateFlexModel() {
            const apiURL = apiBasePath + "/api/v3_0/assets/{{ asset.id }}";
            let data = getFlexModel();

            // Clean null values
            for (const [key, value] of Object.entries(data)) {
                if (value === null) {
                    delete data[key];
                }
            }

            const requestBody = JSON.stringify({ flex_model: JSON.stringify(data) });

            const response = await fetch(apiURL, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                },
                body: requestBody,
            });

            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData?.message || errorData?.error || response.statusText;
                showToast(`Failed to update the flex context: ${errorMessage}`, "error");

                // Revert to previous state
                // const asset = await getAsset("{{ asset.id }}", false);
                // const previousFlexContext = await processResourceRawJSON(assetFlexModelSchema, asset.flex_context);
                // assetFlexContext = previousFlexContext;
                // renderFlexContextForm();
            } else {
                showToast("Flex context updated successfully", "success");
            }
        }

        async function renderSelectInfoCards(modelKey) {
            if (modelKey) {
                flexInfoContainer.innerHTML = `
                <div>
                    <div class="alert alert-info" role="alert">
                        <b> About ${getFlexFieldTitle(modelKey)}
                        <div class="pt-2 fw-normal">
                            ${assetFlexModelFieldDesc[modelKey] || "No description available."}
                        </div>
                    </div>
                </div>
            `;
            } else {
                flexInfoContainer.innerHTML = "";
            }
        }

        async function addFlexContextField() {
            const fieldName = flexSelect.value;
            if (fieldName === "blank") {
                showToast("Please select a field to add", "error");
                return;
            }
            assetFlexContext[fieldName] = "";
            flexOptionsContainer.innerHTML = "";
            await renderFlexContextForm(); // im rendring here so te card with the 'border-on-click' class is updated/exists
            const card = document.getElementById(`${fieldName}-control`);
            selectFlexField(card);
        }

        async function renderFlexModelFieldCard(name, value) {
            const card = document.createElement('div');
            card.className = 'card m-1 mt-0';
            card.id = `${name}-control`;

            card.onclick = function () {
                if (card.classList.contains('border-on-click')) {
                    if (event.target.closest('.fa-times')) {
                        // trigger the close icon's onclick function
                        if (activeCard() && activeCard().id === card.id) {
                            setActiveCard(null); // Deselect if the same card is clicked again
                            card.classList.remove('border-on-click'); // Remove the border class
                        }
                        card.remove(); // Remove the card from the DOM
                        const flexModel = getFlexModel();
                        if (Array.isArray(flexModel[name])) {
                            flexModel[name] = [];
                        } else {
                            flexModel[name] = null;
                        }

                        setFlexModel(flexModel); // Update the state
                        renderFlexFieldOptions(assetFlexModelSchema, getFlexModel()); // Re-render the select options
                        showToast(`Field "${getFlexFieldTitle(name)}" has been unset`, "success");
                        return;
                    }

                    if (activeCard() && activeCard().id === card.id) {
                        setActiveCard(null); // Deselect if the same card is clicked again
                        card.classList.remove('border-on-click'); // Remove the border class
                    } else {
                        setActiveCard(card); // Set the active card
                    }
                    return;
                }

                const allCards = document.querySelectorAll('.card');
                allCards.forEach(c => c.classList.remove('border-on-click'));
                card.classList.add('border-on-click');
                renderSelectInfoCards(name); // Render the info card for the selected field
            }

            const isString = typeof value === "string";
            const isArray = Array.isArray(value);
            const isBool = typeof value === "boolean";
            const isNumber = typeof value === "number";
            const isKeyValueObject = typeof value === "object" &&
                value !== null &&
                !Array.isArray(value) && // Exclude arrays
                Object.keys(value).length > 0;

            card.innerHTML = `
                <div class="card-highlight">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title">${getFlexFieldTitle(name)}</h5>
                        <i class="fa fa-times"
                            onclick=""
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            title="Unset this field"
                            style="cursor: pointer;"
                        ></i>
                    </div>
                    ${isKeyValueObject ? await renderSensor(value["sensor"]) : ''}
                    ${isBool ? `
                        <div class="form-check form-switch">
                            <input class="form-check-input ps-1" style="transform: scale(1.5); margin-left: -2.1em !important" type="checkbox" id="flexSwitchCheckChecked" ${value ? 'checked' : ''} onchange="setFlexModel({ '${name}': this.checked })">
                        </div>
                    ` : ''}
                      ${isNumber ? `<p class="card-text">Value: ${value}</p>` : ''}
                </div>
            `;
            flexmodelContainer.appendChild(card);
            return card;
        }

        async function renderFlexContextForm() {
            flexOptionsContainer.innerHTML = "";
            const assetFlexModel = getFlexModel();
            for (const [key, value] of Object.entries(assetFlexModel)) {
                if (value !== null) {
                    if (Array.isArray(value) && value.length > 0) {
                        const card = await renderFlexModelFieldCard(key, value);
                    } else if (!Array.isArray(value)) {
                        const card = await renderFlexModelFieldCard(key, value);
                    }
                }
            }
        };

        renderFlexFieldOptions(assetFlexModelSchema, getFlexModel());
        renderFlexContextForm();
    });
</script>

{% endblock %}