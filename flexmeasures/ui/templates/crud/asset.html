{% extends "base.html" %}

{% set active_page = "assets" %}

{% block title %} {{asset.name}} {% endblock %}



{% block divs %}

{% block breadcrumbs %} {{ super() }} {% endblock %}

<div class="container-fluid">
    <div class="row mx-1">
        <div class="alert alert-info d-none" id="tzwarn"></div>
        <div class="alert alert-info d-none" id="dstwarn"></div>
    </div>
    <div class="row">
        <div class="col-md-2 on-top-md">
            <div class="header-action-button">
                {% if user_can_create_assets %}
                <div>
                    <form action="/assets/new" method="get">
                        <button class="btn btn-sm btn-responsive btn-success create-button mb-3" type="submit">Create
                            new asset</button>
                    </form>
                </div>
                {% endif %}
                {% if user_can_delete_asset %}
                <div>
                    <form action="/assets/delete_with_data/{{ asset.id }}" method="get">
                        <button id="delete-asset-button" class="btn btn-sm btn-responsive btn-danger"
                            type="submit">Delete this asset</button>
                    </form>
                    <script>
                        $("#delete-asset-button").click(function () {
                            if (confirm("Are you sure you want to delete this asset and all time series data associated with it?")) {
                                return true;
                            }
                            else {
                                return false;
                            }
                        });
                    </script>
                </div>
                {% endif %}
            </div>
            <div class="header-action-button">
                <div>
                    <form action="/assets/{{ asset.id }}/status" method="get">
                        <button id="asset-status-button" class="btn btn-sm btn-responsive btn-info" type="submit">Asset
                            status</button>
                    </form>
                </div>
                <div>
                    <form action="/assets/auditlog/{{ asset.id }}" method="get">
                        <button class="btn btn-sm btn-responsive btn-info" type="submit"
                            title="View history of asset related actions.">Audit log</button>
                    </form>
                </div>
            </div>
            <div class="sidepanel-container">
                <div class="left-sidepanel-label">Select dates</div>
                <div class="sidepanel left-sidepanel">
                    <div id="datepicker"></div>
                </div>
            </div>
            {% if user_can_update_asset %}
            <div class="sidepanel-container">
                <div class="left-sidepanel-label">Edit asset</div>
                <div class="sidepanel left-sidepanel">
                    <form class="form-horizontal" method="POST" action="/assets/{{ asset.id }}">
                        {{ asset_form.csrf_token }}
                        {{ asset_form.hidden_tag() }}
                        <fieldset>
                            <div class="asset-form">

                                <h3>Edit {{ asset.name }}</h3>
                                <small>Owned by account: {{ asset.account_id | accountname }} (ID: {{ asset.account_id
                                    }})</small>

                                <div class="form-group">
                                    {{ asset_form.name.label(class="col-sm-3 control-label") }}
                                    <div class="col-md-3">
                                        {{ asset_form.name(class_="form-control") }}
                                        {% for error in asset_form.errors.name %}
                                        <span style="color: red;">[{{error}}]</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    {{ asset_form.latitude.label(class="col-sm-6 control-label") }}
                                    <div class="col-md-6">
                                        {{ asset_form.latitude(class_="form-control") }}
                                        {% for error in asset_form.errors.latitude %}
                                        <span style="color: red;">[{{error}}]</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    {{ asset_form.longitude.label(class="col-sm-6 control-label") }}
                                    <div class="col-md-6">
                                        {{ asset_form.longitude(class_="form-control") }}
                                        {% for error in asset_form.errors.longitude %}
                                        <span style="color: red;">[{{error}}]</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="assset-type" class="col-sm-6 control-label">Asset Type</label>
                                    <div class="col-md-6">
                                        <input class="form-control" id="asset-type-id" name="asset-type" type="text"
                                            value="{{ asset.generic_asset_type.name }}" disabled></input>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="asset-id" class="col-sm-6 control-label">Asset id</label>
                                    <div class="col-md-6">
                                        <input class="form-control" id="asset-id" name="asset-id" type="text"
                                            value="{{ asset.id }}" disabled></input>
                                    </div>
                                </div>
                          
                                <div class="form-group">
                                    {{ asset_form.attributes.label(class="col-sm-3 control-label") }}
                                    <div class="col-md-3">
                                        {{ asset_form.attributes(class_="form-control") }}
                                        {% for error in asset_form.errors.attributes %}
                                        <span style="color: red;">[{{error}}]</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="flex_context" class="col-sm-6 control-label">Flex Context: </label>
                                
                                    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#flexContextModal">
                                        Edit
                                    </button>
                                </div>

                                <div class="form-group">
                                    <label for="sensors_to_show" class="col-sm-6 control-label">Sensor Graphs: </label>
                                
                                        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#sensorsToShowModal">
                                            Edit Graphs
                                        </button>
                                </div>
                                
                                <div class="form-group">
                                    <label class="control-label">Location</label>
                                    <small>(Click map to edit latitude and longitude in form)</small>
                                    <div id="mapid"></div>
                                    <button class="btn btn-sm btn-responsive btn-success create-button" type="submit"
                                        value="Save"
                                        style="margin-top: 20px; float: right; border: 1px solid var(--light-gray);">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-md-8">
            <div id="spinner" hidden="hidden">
                <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
                <span class="sr-only">Loading...</span>
            </div>
            <div id="sensorchart" class="card" style="width: 100%;"></div>
            <div class="row">
                <div class="copy-url" title="Click to copy the URL to the current time range to clipboard.">
                    <script>
                        function toIsoString(date) {
                            var tzo = -date.getTimezoneOffset(),
                                dif = tzo >= 0 ? '+' : '-',
                                pad = function (num) {
                                    return (num < 10 ? '0' : '') + num;
                                };

                            return date.getFullYear() +
                                '-' + pad(date.getMonth() + 1) +
                                '-' + pad(date.getDate()) +
                                'T' + pad(date.getHours()) +
                                ':' + pad(date.getMinutes()) +
                                ':' + pad(date.getSeconds()) +
                                dif + pad(Math.floor(Math.abs(tzo) / 60)) +
                                ':' + pad(Math.abs(tzo) % 60);
                        }

                        $(window).ready(() => {
                            picker.on('selected', (startDate, endDate) => {
                                startDate = encodeURIComponent(toIsoString(startDate.toJSDate()));
                                endDate = encodeURIComponent(toIsoString(endDate.toJSDate()));
                                var base_url = window.location.href.split("?")[0];
                                var new_url = `${base_url}?start_time=${startDate}&end_time=${endDate}`;

                                // change current url without reloading the page
                                window.history.pushState({}, null, new_url);
                            });

                        });

                        function copyUrl(event) {
                            event.preventDefault();

                            if (!window.getSelection) {
                                alert('Please copy the URL from the location bar.');
                                return;
                            }
                            const dummy = document.createElement('p');

                            var startDate = encodeURIComponent(toIsoString(picker.getStartDate().toJSDate()));
                            // add 1 day to end date as datepicker does not include the end date day
                            var endDate = picker.getEndDate();
                            endDate.setDate(endDate.getDate() + 1);
                            endDate = encodeURIComponent(toIsoString(endDate.toJSDate()));
                            var base_url = window.location.href.split("?")[0];
                            dummy.textContent = `${base_url}?start_time=${startDate}&end_time=${endDate}`
                            document.body.appendChild(dummy);

                            const range = document.createRange();
                            range.setStartBefore(dummy);
                            range.setEndAfter(dummy);

                            const selection = window.getSelection();
                            // First clear, in case the user already selected some other text
                            selection.removeAllRanges();
                            selection.addRange(range);

                            document.execCommand('copy');
                            document.body.removeChild(dummy);

                            $("#message").show().delay(1000).fadeOut();
                        }
                    </script>
                    <a href="#" onclick="copyUrl(event)" style="display: block; text-align: center;">
                        <i class="fa fa-link"></i>
                    </a>
                    <div id="message" style="display: none; text-align: center;">The URL to the time range currently
                        shown has been copied to your clipboard.</div>
                </div>
            </div>

            <div class="sensors-asset card">
                <h3>All sensors for {{ asset.name }}</h3>
                <div class="table-responsive">
                    <table class="table table-striped paginate nav-on-click" title="View data" id="sensorsTable">
                    </table>
                </div>
            </div>

            <div class="sensors-asset card">
                <h3>All child assets for {{ asset.name }}</h3>
                <div class="table-responsive">
                    <table class="table table-striped paginate nav-on-click w-100 mx-auto" title="View this asset">
                        <thead>
                            <tr>
                                <th><i class="left-icon">Name</i></th>
                                <th>Location</th>
                                <th>Asset ID</th>
                                <th>Account</th>
                                <th>Sensors</th>
                                <th class="d-none">URL</th>
                                <th class="no-sort"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for child in asset.child_assets %}
                            <tr>
                                <td>
                                    <i class="{{ child.generic_asset_type.name | asset_icon }} left-icon">{{ child.name
                                        }}</i>
                                </td>
                                <td>
                                    {% if child.latitude and child.longitude %}
                                    LAT: {{ "{:,.4f}".format( child.latitude ) }} LONG:
                                    {{ "{:,.4f}".format( child.longitude ) }}
                                    {% endif %}
                                </td>
                                <td>
                                    {{ child.id }}
                                </td>
                                <td>
                                    {% if child.owner %}
                                    {{ child.owner.name }}
                                    {% else %}
                                    PUBLIC
                                    {% endif %}
                                </td>
                                <td>
                                    {{ child.sensors | length }}
                                </td>
                                <td class="d-none">
                                    /assets/{{ child.id }}
                                </td>
                                <td>
                                    <a href="/assets/{{ child.id }}/status">
                                        <button type="button" class="btn">Status</button>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="replay-container">
                <div id="replay" title="Press 'p' to play/pause/resume or 's' to stop." class="stopped"></div>
                <div id="replay-time"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div class="modal fade modal-xl" id="sensorsToShowModal" tabindex="-1" aria-labelledby="sensorsToShowModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title pe-2">Edit Dashboard Graphs</h5>
                    
                    <div class="dropdown" data-bs-auto-close="outside">
                        <span
                          class="fa fa-info dropdown-toggle"
                          role="button"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                          rel="tooltip"
                          aria-hidden="true"
                          tabindex="0"
                          data-bs-placement="right"
                          data-bs-toggle="tooltip"
                       ></span>
                      
                        <div class="dropdown-menu p-3" style="width: 400px;">
                            <div>
                                <strong>Dashboard Graphs Help</strong>
                                <p class="mb-2">
                                  Here you can edit what data is shown in the Dashboard Graphs. Each graph can show one or more sensors 
                                  (<em>it makes sense to show sensors in a graph that share the same unit</em>).
                                </p>
                                <p class="mb-2">
                                  You can also set the title of each graph and re-order them. Select a graph 
                                  <span class="text-primary">(by clicking on its card)</span> to add sensors to it.
                                </p>
                                <p class="mb-0">
                                  Sensors can be searched on the right. This will list sensors on the asset or its child asset, as well as public assets.
                                </p>
                            </div>
                        </div>
                    </div>
                      
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col">

                            <button class="btn btn-primary mb-3" onclick="addNewGraph()">
                                Add Graph
                            </button>

                            <div id="graphList" class="row"></div>
                        </div>
                      
                        <div class="col">
                            <div class="row mb-3">
                                <div class="col-8">
                                    <input
                                        type="text"
                                        id="searchInput"
                                        class="form-control"
                                        placeholder="Search sensors..."
                                        oninput="filterSensors()"
                                    />
                                </div>
                        
                                <div class="col-4">
                                    <select id="unitsSelect" class="form-select" onchange="filterSensors()">
                                        <option selected>Units</option>
                                        {% for unit in available_units %}
                                        <option>{{ unit }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                         
                            <div class="container">
                                <div id="spinnerElement" class="d-flex justify-content-center align-items-center mb-2" style="height: 50vh; display: none !important;">
                                    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            
                                <div id="apiSensorsList" class="row" style="display: none;"></div>
                            </div>

                        </div>
                      </div>
                      
                </div>
            </div>
        </div>
    </div>

    <!-- Flex Context Modal -->
    <div class="modal fade modal-xl" id="flexContextModal" tabindex="-1" aria-labelledby="flexContextModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title pe-2">Edit Asset's FlexContext</h5>
                    
                    <div class="dropdown" data-bs-auto-close="outside">
                        <span
                          class="fa fa-info dropdown-toggle"
                          role="button"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                          rel="tooltip"
                          aria-hidden="true"
                          tabindex="0"
                          data-bs-placement="right"
                          data-bs-toggle="tooltip"
                       ></span>
                      
                        <div class="dropdown-menu p-3" style="width: 400px;">
                            <div>
                                <strong>Help</strong>
                                <p class="mb-2">
                                  Here you can edit the asset's flex context.
                                </p>
                            </div>
                        </div>
                    </div>
                      
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-5">
                            <form id="flexContextForm">
                            </form>
                        </div>

                        <!-- Right Column -->
                        <div class="col-7">
                            <div>
                                <!-- Loading Spinner -->
                                <div id="spinnerElement" class="d-flex justify-content-center align-items-center mb-2" style="height: 50vh; display: none !important;">
                                    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Settings -->
                                <div>
                                    <select class="form-select" id="flexSelect">
                                        <option value="blank">Select an option</option>
                                    </select>
                            
                                    <div id="flexInfoContainer" class="mt-3"></div> 
                                </div>

                                <hr class="border border-dark"/>

                                <!-- Flex InputTypes -->
                                <div id="flexInputsContainer" class="mt-3"></div> 

                                <!-- Filtered or Searched Sensors -->
                                <div id="power-capacity-input" class="flex-input-group mb-4" style="display:none;">
                                    <label for="power-capacity" class="form-label">Power Capacity</label>
                                    <input type="text" id="power-capacity" class="form-control" placeholder="e.g. 15W">
                                    <button class="btn btn-secondary btn-sm me-2 mt-2" onclick="udpateFlexContextFieldValue('power', 0)">Add Value</button>
                                </div>
            
                                <div id="select-sensor-input" class="flex-input-group mb-4" style="display:none;">
                                    <label for="sensor" class="form-label">Look up Sensor: </label>
                                    <input
                                        type="text"
                                        id="flexContextSensorSearch"
                                        class="form-control"
                                        placeholder="Search sensors..."
                                        oninput="searchSensors()"
                                    />
                            
                                    <div id="sensorsSearchResults" class="row mt-3" style="display: none;"></div>
                                </div>  
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.7/jstz.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/ranges.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/plugins/keyboardnav.js"></script>

{% block leftsidepanel %} {{ super() }} {% endblock %}
{% block sensorChartSetup %} {{ super() }} {% endblock %}

<!-- Initialise the map -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet-src.min.js"></script>
<script src="{{ url_for('flexmeasures_ui.static', filename='js/map-init.js') }}"></script>

<script>
    const senSearchResEle = document.getElementById("sensorsSearchResults")
    const flexContextFormEle = document.getElementById("flexContextForm")
    const flexContexFormModal = document.getElementById('flexContextModal');
    const flexSelect = document.getElementById('flexSelect');
    const flexInfoContainer = document.getElementById('flexInfoContainer');
    const flexInputsContainer = document.getElementById('flexInputsContainer');
    

    let assetFlexContext = {
        "consumption-price":  null,
        "production-price":  null, 
        "site-power-capacity": null,
        "site-production-capacity":  null,
        "site-consumption-capacity":  null,
        "site-consumption-breach-price":  null,
        "site-production-breach-price":  null,
        "site-peak-consumption":  null,
        "site-peak-consumption-price":  null,
        "site-peak-production":  null,
        "site-peak-production-price":  null,
        "inflexible-device-sensors": []
    }
    let assetFlexContextRawJSON = "{{ asset.flex_context | safe }}";
    assetFlexContextRawJSON = assetFlexContextRawJSON.replace(/'/g, '"');
    // change None to null
    assetFlexContextRawJSON = assetFlexContextRawJSON.replace(/None/g, 'null');
    // update the assetFlexContext fields
    assetFlexContextRawJSON = JSON.parse(assetFlexContextRawJSON);

    for (const [key, value] of Object.entries(assetFlexContextRawJSON)) {
        if (key in assetFlexContext) {
            assetFlexContext[key] = assetFlexContextRawJSON[key];
        } else {
            assetFlexContext[key] = null;
        }
    }
    $(document).ready(function () {
        // Use event delegation to handle dynamically added elements
        $(document).on('change', '[id^="input-type-"]', function () {
            console.log("Input type changed");
            let selectedOption = $(this).val();
            $('.flex-input-group').hide();

            if (selectedOption === 'power-capacity') {
                $('#power-capacity-input').show();
            } else if (selectedOption === 'select-sensor') {
                $('#select-sensor-input').show();
            }
        });

        // Trigger the change event initially to show the default option's input
        $('#input-type-site-power-capacity').trigger('change');
    });

    const formModal = document.getElementById('sensorsToShowModal');
    const apiSensorsListElement = document.getElementById("apiSensorsList");
    const spinnerElement = document.getElementById('spinnerElement');
    let sensorsToShowRawJSON = "{{ asset.sensors_to_show | safe }}";
    sensorsToShowRawJSON = sensorsToShowRawJSON.replace(/'/g, '"');
    let sensorsToShow = JSON.parse(sensorsToShowRawJSON);
    let cachedFilteredSensors = []; // keeps track of the filtered sensors
    let editingIndex; // keeps track of which graph we are currently editing
    let savedGraphIndex; // keeps track of the graph that is currently selected
    let selectedGraphTitle; // keeps track of the graph title that is currently selected
    const apiBasePath = window.location.origin;
    const sensorsApiUrl = `${apiBasePath}/api/v3_0/sensors?page=1&per_page=100&asset_id={{ asset.id }}&include_public_assets=true`;
    
    // Fetch Account Details
    async function getAccount(accountId) {
        const cacheKey = `account_${accountId}`;
        const cachedData = localStorage.getItem(cacheKey);
    
        if (cachedData) {
            return JSON.parse(cachedData);
        }
    
        const apiUrl = apiBasePath + "/api/v3_0/accounts/" + accountId;
        const response = await fetch(apiUrl);
        const account = await response.json();
    
        localStorage.setItem(cacheKey, JSON.stringify(account));
    
        return account;
    }
    
    // Fetch Asset Details
    async function getAsset(assetId) {
        const cacheKey = `asset_${assetId}`;
        const cachedData = localStorage.getItem(cacheKey);
    
        if (cachedData) {
            return JSON.parse(cachedData);
        }
    
        const apiUrl = apiBasePath + "/api/v3_0/assets/" + assetId;
        const response = await fetch(apiUrl);
        const asset = await response.json();
    
        localStorage.setItem(cacheKey, JSON.stringify(asset));
    
        return asset;
    }
    
    // Fetch Sensor Details
    async function getSensor(id) {
        const cacheKey = `sensor_${id}`;
        const cachedData = localStorage.getItem(cacheKey);
    
        if (cachedData) {
            return JSON.parse(cachedData);
        }
    
        const apiUrl = apiBasePath + "/api/v3_0/sensors/" + id;
        const response = await fetch(apiUrl);
        const sensor = await response.json();
    
        localStorage.setItem(cacheKey, JSON.stringify(sensor));
    
        return sensor;
    }
    
    // highlight selected graph 
    async function selectGraph(graphIndex) {
        if (graphIndex !== undefined) {
            savedGraphIndex = graphIndex;
            selectedGraphTitle = sensorsToShow[graphIndex]?.title;
            // check if graphIndex still exists(This is because this function is called when the removed button is clicked as well)
            if (sensorsToShow[graphIndex]) {
                renderApiSensors(cachedFilteredSensors, graphIndex);
            } else {
                renderApiSensors(cachedFilteredSensors);
            }
        } else {
            savedGraphIndex = undefined;
            selectedGraphTitle = undefined;
            renderGraphCards();
        }
    }
    
    // Function to render the graph cards
    async function renderGraphCards() {
        const graphList = document.getElementById("graphList");
        graphList.innerHTML = "";
        const newSensorsToShow = [];
    
        if (sensorsToShow.length === 0) {
            return;
        }
    
        for (const [index, item] of sensorsToShow.entries()) {
            const col = document.createElement("div");
            col.classList.add("col-12", "mb-1");
    
            const sensorsUnits = [];
            // the initializing of the newItem is to handle the case where the item is an array of ID's instead of an object
            const newItem = {
                title: item.title ?? "No Title",
                sensors: item.sensors ?? (Array.isArray(item) ? item : [item]),
            }
            newSensorsToShow.push(newItem);
    
            const sensorsContent = await Promise.all(
                newItem.sensors.map(async (sensor, sensorIndex) => {
                    const sensorData = await getSensor(sensor);
                    const Asset = await getAsset(sensorData.generic_asset_id);
                    const Account = await getAccount(Asset.account_id);
                    sensorsUnits.push(sensorData.unit);
    
                return `
                    <div class="p-1 mb-3 border-bottom border-secondary">
                        <div class="d-flex justify-content-between">
                            <div>
                                <b>ID:</b> <a href="${apiBasePath}/sensors/${sensorData.id}">${sensorData.id}</a>,
                                <b>Unit:</b> ${sensorData.unit},
                                <b>Name:</b> ${sensorData.name},
                                <div style="padding-top: 1px;"></div>
                                <b>Asset:</b> ${Asset.name},
                                <b>Account:</b> ${Account?.name ? Account.name : "PUBLIC"}
                            </div>
                            <i class="fa fa-times"
                                onclick="removeSensorFromGraph(${index}, ${sensorIndex})"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Remove Sensor"
                                style="cursor: pointer;"
                            ></i>
                        </div>

                    </div>`;
            }));

            const uniqueUnits = [...new Set(sensorsUnits)];

            col.innerHTML = `
            <div class="card m-0 p-1">
                <div class="card-body card-highlight ${newItem.title === selectedGraphTitle ? " border-on-click" : ""}" id="graph_${index}" onclick="selectGraph(${index})">
                    <div class="d-flex align-items-center">
                        <div>
                            ${editingIndex === index
                            ? `<input type="text" class="form-control mb-2 me-2" id="editTitle_${index}" value="${newItem.title}" onkeydown="handleEnterKeyEventForTitleEditing(event, ${index})" />`
                            : `<h5 class="card-title me-2">${newItem.title}</h5>`
                        }
                        </div>

                        <div>
                            ${editingIndex === index
                            ? `<button class="btn btn-success btn-sm ms-2" id="saveTitleBtn" onclick="saveGraphTitle(${index})">Save</button>`
                            : `<button class="btn btn-warning btn-sm ms-2" id="editTitleBtn" onclick="editGraphTitle(${index})">Edit</button>`
                        }
                        </div>
                    </div>
                    <h5 class="card-title pt-2"><b> Sensors: </b></h5>
                    <div>
                        ${sensorsContent.length > 0 ? sensorsContent.join("") : `<div class="alert alert-warning" role="alert"> No sensors added to this graph. Add sensors by selecting them from the right</div>`}
                        ${uniqueUnits.length > 1 ? `<div class="alert alert-warning" role="alert">Note that you are showing sensors with different units</div>` : ""}
                    </div>

                    <button class="btn btn-danger btn-sm me-2" onclick="(function(e) { e.stopPropagation(); removeGraph(${index}); })(event)">Remove</button>
                    <button class="btn btn-secondary btn-sm me-2" onclick="(function(e) { e.stopPropagation(); moveGraphUp(${index}); })(event)" ${index === 0 ? "disabled" : ""}>Move Up</button>
                    <button class="btn btn-secondary btn-sm" onclick="(function(e) { e.stopPropagation(); moveGraphDown(${index}); })(event)" ${index === sensorsToShow.length - 1 ? "disabled" : ""}>Move Down</button>
                </div>
            </div>`;

            graphList.appendChild(col);
        }
    
        sensorsToShow = newSensorsToShow;
    }
    
    async function filterSensors() {
        const searchValue = document.getElementById("searchInput").value.toLowerCase();
        const filterValue = document.getElementById("unitsSelect").value;
        const highlightedCard = document.querySelector('.border-on-click');
        spinnerElement.style.display = 'flex';
        apiSensorsListElement.style.display = 'none';
    
        // Due to the nature of async functions, the highlightedCard might not be available
        // when the filterSensors function is called. So, we need to check if it exists
        if (highlightedCard) {
            const cardId = highlightedCard.id;
            const index = cardId.split("_")[1];
            savedGraphIndex = index;
            selectedGraphTitle = sensorsToShow[index].title;
        } else {
            savedGraphIndex = undefined;
            selectedGraphTitle = undefined;
        }
    
        // check if apiSensorsList has been rendered
        if (apiSensorsListElement.innerHTML === "") {
            document.getElementById('apiSensorsList').style.display = 'block';
        }
    
        const params = new URLSearchParams();
    
        if (searchValue) {
            params.append('filter', searchValue);
        }
    
        if (filterValue !== "Units") {
            params.append('unit', filterValue);
        }
    
        const apiUrl = `${sensorsApiUrl}&${params.toString()} `;
    
        try {
            const response = await fetch(apiUrl);
    
            if (!response.ok) {
                throw new Error('Failed to fetch sensors');
            }
    
            const responseData = await response.json();
            const filteredSensors = responseData.data;
    
            // Render the fetched sensors
            if (savedGraphIndex !== null && savedGraphIndex !== undefined) {
                renderApiSensors(filteredSensors, savedGraphIndex);
            } else {
                renderApiSensors(filteredSensors);
            }
    
            cachedFilteredSensors = filteredSensors;
    
            spinnerElement.classList.add('hidden-important');
            apiSensorsListElement.style.display = 'block';
        } catch (error) {
            showToast("Failed to filter/search sesnors", "error");
            console.error(error);
        }
    }

    async function searchSensors() {
        const searchValue = document.getElementById("flexContextSensorSearch").value.toLowerCase();
        spinnerElement.style.display = 'flex';
        senSearchResEle.style.display = 'none';

        const params = new URLSearchParams();

        if (searchValue) {
            params.append('filter', searchValue);
        }

        const apiUrl = `${sensorsApiUrl}&${params.toString()} `;

        try {
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error('Failed to fetch sensors');
            }

            const responseData = await response.json();
            const filteredSensors = responseData.data;

            // Render the fetched sensors
            renderSensorSearchResults(filteredSensors);

            spinnerElement.classList.add('hidden-important');
            senSearchResEle.style.display = 'block';
        } catch (error) {
            showToast("Failed to filter/search sesnors", "error");
            console.error(error);
        }
    }
    
    
    // ============== Graph Cards Management ============== //
    
    async function removeGraph(index) {
        sensorsToShow.splice(index, 1);
        savedGraphIndex = undefined;
        selectedGraphTitle = undefined;
        editingIndex = undefined;
        renderGraphCards();
        renderApiSensors(cachedFilteredSensors);
    }
    
    async function swapItems(index1, index2) {
        if (index1 >= 0 && index2 >= 0 && index1 < sensorsToShow.length && index2 < sensorsToShow.length) {
            [sensorsToShow[index1], sensorsToShow[index2]] = [sensorsToShow[index2], sensorsToShow[index1]];
            renderGraphCards()
            renderApiSensors(cachedFilteredSensors, index2);
        }
    }
    
    async function moveGraphUp(index) {
        if (index > 0) {
            await swapItems(index, index - 1);
        }
    }
    
    async function moveGraphDown(index) {
        if (index < sensorsToShow.length - 1) {
            await swapItems(index, index + 1);
        }
    }
    
    function editGraphTitle(index) {
        editingIndex = index;
    }
    
    async function saveGraphTitle(index) {
        const newTitle = document.getElementById(`editTitle_${index}`).value;
        sensorsToShow[index].title = newTitle;
        editingIndex = null;
        selectedGraphTitle = newTitle;
        renderGraphCards();
    }
    
    // ============== Graph Cards Management ============== //
    
    
    
    // Render the available API sensors
    function renderApiSensors(sensors, graphIndex) {
        // graphIndex is undefined when the sensors are being added to the graph
        // graphIndex is defined when the sensors are being added to the graph cards. In other words 
        // when more sensors are being added to single graph

        apiSensorsList.innerHTML = ""; // Clear the previous sensors
        if (sensors.length === 0) {
            apiSensorsList.innerHTML = "<h3>No sensors found</h3>";
            return;
        }
        sensors.forEach(async (sensor) => {
            const Asset = await getAsset(sensor.generic_asset_id);
            const Account = await getAccount(Asset.account_id);
    
            const col = document.createElement("div");
            col.classList.add("col-12", "mb-1");
    
            col.innerHTML = `
            <div class="card m-0">
                <div class="card-body p-0 sensor-card">
                    <h5 class="card-title">${sensor.name}</h5>
                    <p class="card-text">
                        <b>ID:</b> <a href="${apiBasePath}/sensors/${sensor.id}">${sensor.id}</a>,
                        <b>Unit:</b> ${sensor.unit},
                        <b>Asset:</b> ${Asset.name},
                        <b>Account:</b> ${Account?.name ? Account.name : "PUBLIC"}
                    </p>
                    ${graphIndex !== undefined && savedGraphIndex !== undefined && selectedGraphTitle !== undefined
                        ? `<button class="btn btn-primary btn-sm" onclick="addSensorToExistingGraph(${graphIndex}, ${sensor.id})">Add to '${selectedGraphTitle}' Graph</button>`
                        : `<button class="btn btn-primary btn-sm" onclick="addSensorAsGraph(${sensor.id})">Add new Graph</button>`
                    }
                </div>
            </div>
        `;
    
            apiSensorsList.appendChild(col);
        });
    }
    
    function renderSensorSearchResults(sensors){
        senSearchResEle.innerHTML = "";
        if (sensors.length === 0) {
            apiSensorsList.innerHTML = "<h3>No sensors found</h3>";
            return;
        }

        sensors.forEach(async (sensor) => {
            const Asset = await getAsset(sensor.generic_asset_id);
            const Account = await getAccount(Asset.account_id);
    
            const col = document.createElement("div");
            col.classList.add("col-12", "mb-1");
    
            col.innerHTML = `
                <div class="card m-0">
                    <div class="card-body p-0 sensor-card">
                        <h5 class="card-title">${sensor.name}</h5>
                        <p class="card-text">
                            <b>ID:</b> <a href="${apiBasePath}/sensors/${sensor.id}">${sensor.id}</a>,
                            <b>Unit:</b> ${sensor.unit},
                            <b>Asset:</b> ${Asset.name},
                            <b>Account:</b> ${Account?.name ? Account.name : "PUBLIC"}
                        </p>
                        <button class="btn btn-primary btn-sm" onclick="udpateFlexContextFieldValue('sensor', ${sensor.id})">Add Sensor</button>
                    </div>
                </div>
            `;

            senSearchResEle.appendChild(col);
        });
    }

    async function updateAssetSensorsToShow(dataType) {

        const apiURL = apiBasePath + "/api/v3_0/assets/{{ asset.id }}";
        let requestBody;

        if (dataType === "sensorToShow") {
            requestBody = JSON.stringify({ sensors_to_show: JSON.stringify(sensorsToShow) });
            // Only show the spinner if relevant to this specific data type
            document.getElementById('spinner').style.display = 'block'; 
        } else if (dataType === "flexContext") {
            // remove null fields
            for (const [key, value] of Object.entries(assetFlexContext)) {
                if (value === null) {
                    delete assetFlexContext[key];
                }
            }
            requestBody = JSON.stringify({ flex_context: JSON.stringify(assetFlexContext) });
        }   

        const response = await fetch(apiURL, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
            },
            body: requestBody,
        });
    
        if (!response.ok) {
            const errorData = await response.json(); 
            const errorMessage = errorData?.message || errorData?.error || response.statusText; 
            showToast(`Failed to update the asset: ${errorMessage}`, "error");
        } else {
            document.dispatchEvent(new Event('sensorsToShowUpdated'));
            showToast("Changes saved successfully", "success");
        }
    }
    
    // Add a sensor as a new graph card
    function addSensorAsGraph(id) {
        const newAsset = {
            title: "No Title",
            sensors: [id],
        };
        sensorsToShow.push(newAsset);
        renderGraphCards();
    }
    
    // Add blank graph to the graph cards
    function addNewGraph() {
        const newAsset = {
            title: "No Title " + (sensorsToShow.length + 1),
            sensors: [],
        };
        selectedGraphTitle = newAsset.title;
        sensorsToShow.push(newAsset);
        selectGraph(sensorsToShow.length - 1)
        renderGraphCards();
    }
    
    // Add Sensor to an existing graph card
    function addSensorToExistingGraph(graphIndex, sensorId) {
        sensorsToShow[graphIndex].sensors.push(sensorId);
        renderGraphCards();
    }
    
    // Remove sensor from the graph sensor list
    function removeSensorFromGraph(graphIndex, sensorIndex) {
        sensorsToShow[graphIndex].sensors.splice(sensorIndex, 1);
        renderGraphCards();
        renderApiSensors(cachedFilteredSensors);
    }
    
    function handleEnterKeyEventForTitleEditing(event, graphIndex) {
        if (event.key === "Enter") {
            saveGraphTitle(graphIndex);
            renderApiSensors(cachedFilteredSensors, graphIndex);
        }
    }


    // ============== Flex Context Management ============== //

    async function removeFlexContextValue(fieldName) {
        assetFlexContext[fieldName] = null;
        renderFlexContextForm();
    }

    async function removeFlexContextSensorValue(fieldName, sensorId) {
        const sensorIndex = assetFlexContext[fieldName].indexOf(sensorId);
        assetFlexContext[fieldName].splice(sensorIndex, 1);
        renderFlexContextForm();
    }

    async function renderFlexContextInputField(fieldName) {
        senSearchResEle.innerHTML = "";
        let fieldValue = assetFlexContext[fieldName] 
        let newFieldValue;
        let sensorsContent = [];

        if (fieldValue === null) {
            newFieldValue = ""
        } else if (typeof fieldValue === "object") {
            if (fieldValue["sensor"]) {
                newFieldValue = `{&quot;sensor&quot;: ${fieldValue["sensor"]}}`
            isSensorValue = true;
            } else if (fieldValue.length > 0) {
                newFieldValue = fieldValue.join(", ")
            }
        } else if (typeof fieldValue == "string"){
            newFieldValue = fieldValue
        }

        const isString = typeof fieldValue === "string";
        const isArray = Array.isArray(fieldValue);
        const isKeyValueObject = typeof fieldValue === "object" && 
                       fieldValue !== null && 
                       !Array.isArray(fieldValue) && // Exclude arrays
                       Object.keys(fieldValue).length > 0;
        const InputTitle = fieldName.split("-").map((word) => word.charAt(0).toUpperCase() + word.slice(1)).join(" ");


        if (isKeyValueObject){
            const sensors = [fieldValue["sensor"]]
            sensorsContent = await Promise.all(
                sensors.map(async (sensor, sensorIndex) => {
                    const sensorData = await getSensor(fieldValue["sensor"]);
                    const Asset = await getAsset(sensorData.generic_asset_id);
                    const Account = await getAccount(Asset.account_id);
    
                return `
                    <div class="p-1 mb-3 border-bottom border-secondary">
                        <div class="d-flex justify-content-between">
                            <div>
                                <b>ID:</b> <a href="${apiBasePath}/sensors/${sensorData.id}">${sensorData.id}</a>,
                                <b>Unit:</b> ${sensorData.unit},
                                <b>Name:</b> ${sensorData.name},
                                <div style="padding-top: 1px;"></div>
                                <b>Asset:</b> ${Asset.name},
                                <b>Account:</b> ${Account?.name ? Account.name : "PUBLIC"}
                            </div>
                            <i class="fa fa-times"
                                onclick="removeFlexContextValue('${fieldName}')"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Remove Sensor"
                                style="cursor: pointer;"
                            ></i>
                        </div>

                    </div>`;
            }));
        } else if (isArray) {
            sensorsContent = await Promise.all(
                fieldValue.map(async (sensor, sensorIndex) => {
                    const sensorData = await getSensor(sensor);
                    const Asset = await getAsset(sensorData.generic_asset_id);
                    const Account = await getAccount(Asset.account_id);
    
                return `
                    <div class="p-1 mb-3 border-bottom border-secondary">
                        <div class="d-flex justify-content-between">
                            <div>
                                <b>ID:</b> <a href="${apiBasePath}/sensors/${sensorData.id}">${sensorData.id}</a>,
                                <b>Unit:</b> ${sensorData.unit},
                                <b>Name:</b> ${sensorData.name},
                                <div style="padding-top: 1px;"></div>
                                <b>Asset:</b> ${Asset.name},
                                <b>Account:</b> ${Account?.name ? Account.name : "PUBLIC"}
                            </div>
                            <i class="fa fa-times"
                                onclick="removeFlexContextSensorValue('${fieldName}')"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Remove Sensor"
                                style="cursor: pointer;"
                            ></i>
                        </div>
                    </div>`;
            }));
        }

        return `
            <div class="row g-2 my-1 card-highlight p-1" id="${fieldName}-control">
                <div class="mb-2 border-bottom border-secondary d-flex justify-content-between align-items-center pb-2">
                    <label id="${fieldName}-label" for="${fieldName}-control-input" class="form-label mb-0 fs-5 fw-semi-bold">${InputTitle}</label>
                </div>

                ${isKeyValueObject || isArray ? `
                <div>
                    ${sensorsContent.length > 0 ? sensorsContent.join("") : `<div class="alert alert-warning" role="alert"> No sensors added to this graph. Add sensors by selecting them from the right</div>`}
                </div>
                ` : ""}

                ${isString ? `
                <div class="shadow-sm border border-secondary p-2">
                    <span class="fw-light fs-5">${newFieldValue ? newFieldValue : "<i>Not Set</i>"}</span>
                </div>
                ` : ""}
            </div>
        `;
    }

    async function renderFlexContextForm() {
        flexContextFormEle.innerHTML = "";
        
        for (const [key, value] of Object.entries(assetFlexContext)) {
            if (value !== null){
                flexContextFormEle.innerHTML += await renderFlexContextInputField(key);
            }
        }

        renderFlexSelectOptions();
    }

    function udpateFlexContextFieldValue(dataType, sensorId) {
        const powerCapacityInputValue = document.getElementById("power-capacity").value;
        const highlightedCard = document.querySelector('.border-on-click');
        console.log(highlightedCard);
        if (!highlightedCard) {
            showToast("Please select a field to update", "error");
            return;
        }
        // get card id and remove '-control' at the end
        const cardId = highlightedCard.id;
        const flexId = cardId.slice(0, -8);
        if (dataType === "power") {
            assetFlexContext[flexId] = powerCapacityInputValue;
        } else if (dataType === "sensor"){
            if (flexId === "inflexible-device-sensors") {
                assetFlexContext[flexId].push(sensorId);
            } else {
                assetFlexContext[flexId] = {sensor: sensorId};
            }
        }

        renderFlexContextForm();
    }

    async function addFlexContextField(fieldName) {
        assetFlexContext[fieldName] = "";
        flexInputsContainer.innerHTML = "";
        await renderFlexContextForm(); // im rendring here so te card with the 'border-on-click' class is updated/exists
        const card = document.getElementById(`${fieldName}-control`);
        // remove the border other cards
        document.querySelectorAll(".card-highlight").forEach(el => el.classList.remove("border-on-click"));
        card.classList.add("border-on-click");
        if (fieldName !== "inflexible-device-sensors") {
            flexInputsContainer.innerHTML = renderFlexInputOptions(fieldName);
        } else {
            flexInputsContainer.innerHTML = renderFlexInputOptions(fieldName, true);
        }
    }

    function renderFlexSelectOptions() {
        flexSelect.innerHTML = `<option value="blank">Select an option</option>`;
        for (const [key, value] of Object.entries(assetFlexContext)) {
            if (value === null){
                flexSelect.innerHTML += `<option value="${key}">${key.split("-").map((word) => word.charAt(0).toUpperCase() + word.slice(1)).join(" ")}</option>`;
            }
        }
        
    }
    function renderSelectInfoCards(contextKey, description, isArray=false) {
        return `
            <div>
                <div class="alert alert-light" role="alert">
                    <b> About Field </b>
                    <div class="pt-2">
                        ${description}
                    </div>
                </div>

                <button class="btn btn-secondary btn-md" id="" ${assetFlexContext[contextKey] ? "disabled" : "" } onclick="addFlexContextField('${contextKey}')">Add Field</button>
            </div>
        `;
    }

    function renderFlexInputOptions(contextKey, isArray=false) {
        return `
            <div class="mb-3">
                <label for="input-type-${contextKey}" class="form-label">Choose Input Type:</label>
                <select id="input-type-${contextKey}" class="form-select">
                    <option value="select-type">Select Type</option>
                    ${isArray ? "": `<option value="power-capacity">Fixed Value</option>`}
                    <option value="select-sensor">Select Sensor</option>
                </select>
            </div>
        `;
    }

    function selectFlexField(){

    }

    // ============== Flex Context Management ============== //


    // ============== Page Events ============== //
    
    formModal.addEventListener('hidden.bs.modal', function () {
        updateAssetSensorsToShow("sensorToShow");
    });

    formModal.addEventListener('shown.bs.modal', function () {
        // Initial renders
        renderGraphCards(); // Initial render of graph cards
        filterSensors(); // Initial render of sensors
    });

    flexContexFormModal.addEventListener('shown.bs.modal', function () {
        // Initial renders
        renderFlexContextForm(); // Initial render of flex context form
    });

    flexContexFormModal.addEventListener('hidden.bs.modal', function () {
        updateAssetSensorsToShow("flexContext");
    });
    
    document.addEventListener("click", function (event) {
        /**
        The logic in this block is majorly to remove the border on click of the card and add it to the selected card
        but as this event is added to the document, it will be triggered on any click event on the page
        so the if statements are used to check if the click event is on the card or not
        */
        const card = event.target.closest(".card-highlight");
        const sensorCard = event.target.closest(".sensor-card");
        const searchInput = event.target.id === "searchInput";
        const cardBody = event.target.closest(".card-body");
        const editTitleBtn = event.target.id === "editTitleBtn";
        const saveTitleBtn = event.target.id === "saveTitleBtn";

        if (card) {
            if (card.classList.contains("border-on-click")) {
                if (editTitleBtn || saveTitleBtn) {
                    renderGraphCards();
                }
                // Pass
            } else {
                document.querySelectorAll(".card-highlight").forEach(el => el.classList.remove("border-on-click"));
                flexInputsContainer.innerHTML = "";
                card.classList.add("border-on-click");
                const cardLabel = card.querySelector("label");
                if (cardLabel) {
                    // remvoe "-label" at the end leaing the flexcontext key
                    const flexKey = cardLabel.id.slice(0, -6);
                    if (flexKey !== "inflexible-device-sensors") {
                        flexInputsContainer.innerHTML = renderFlexInputOptions(flexKey);
                    } else {
                        flexInputsContainer.innerHTML = renderFlexInputOptions(flexKey, true);
                    }
                }
                renderGraphCards();
            }
        } else if (
            cardBody !== null && cardBody !== undefined ||
            sensorCard !== null && sensorCard !== undefined ||
            searchInput !== null && searchInput !== undefined
        ) {
            // Pass
        } else {
            document.querySelectorAll(".card-highlight").forEach(el => el.classList.remove("border-on-click"));
            renderApiSensors([], undefined);
        }
    });

    flexSelect.addEventListener('change', function() {
        const selectedOption = flexSelect.value;
        flexInfoContainer.innerHTML = "";
        const alertStyle = "alert alert-light";
        if (selectedOption === "consumption-price") {
            const description = "Set the sensor that represents the consumption price of the site. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("consumption-price", description);
        } else if (selectedOption === "production-price") {
            const description = "Set the sensor that represents the production price of the site. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("production-price", description);
        } else if (selectedOption == "site-power-capacity"){
            const description = "This value represents the maximum power that the site can consume or produce. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-power-capacity", description);
        } else if (selectedOption == "site-production-capacity"){
            const description = "This value represents the maximum power that the site can produce. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-production-capacity", description);
        } else if (selectedOption == "site-consumption-capacity"){
            const description = "This value represents the maximum power that the site can consume. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-consumption-capacity", description);
        } else if (selectedOption == "site-consumption-breach-price"){
            const description = "This value represents the price that will be paid if the site consumes more power than the site consumption capacity. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-consumption-breach-price", description);
        } else if (selectedOption == "site-production-breach-price"){
            const description = "This value represents the price that will be paid if the site produces more power than the site production capacity. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-production-breach-price", description);
        } else if (selectedOption == "site-peak-consumption"){
            const description = "This value represents the peak consumption of the site. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-peak-consumption", description);
        } else if (selectedOption == "site-peak-consumption-price"){
            const description = "This value represents the price that will be paid if the site consumes more power than the site peak consumption. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-peak-consumption-price", description);
        } else if (selectedOption == "site-peak-production"){
            const description = "This value represents the peak production of the site. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-peak-production", description);
        } else if (selectedOption == "site-peak-production-price"){
            const description = "This value represents the price that will be paid if the site produces more power than the site peak production. This value will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("site-peak-production-price", description);
        } else if (selectedOption == "inflexible-device-sensors"){
            const description = "This value represents the sensors that are inflexible and cannot be controlled. These sensors will be used in the optimization";
            flexInfoContainer.innerHTML = renderSelectInfoCards("inflexible-device-sensors", description);
        }
    });

    // ============== Page Events ============== //
</script>
<script type="text/javascript">

    // create map
    var assetMap = L
        .map('mapid', { center: [{{ asset.latitude | replace("None", 10) }}, {{ asset.longitude | replace("None", 10) }}], zoom: 10})
        .on('popupopen', function () {
            $(function () {
                $('[data-toggle="tooltip"]').tooltip();
            });
        });
    addTileLayer(assetMap, '{{ mapboxAccessToken }}');

    // create marker
    var asset_icon = new L.DivIcon({
        className: 'map-icon',
        html: '<i class="icon-empty-marker center-icon supersize"></i><i class="overlay center-icon {{ asset.generic_asset_type.name | default("info") | asset_icon }}"></i>',
        iconSize: [100, 100], // size of the icon
        iconAnchor: [50, 50], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -50] // point from which the popup should open relative to the iconAnchor
    });
    var marker = L
        .marker(
            [{{ asset.latitude | replace("None", 10) }}, {{ asset.longitude | replace("None", 10) }}],
    { icon: asset_icon }
        ).addTo(assetMap);

    assetMap.on('click', function (e) {
        $("#latitude").val(e.latlng.lat.toFixed(4));
        $("#longitude").val(e.latlng.lng.toFixed(4));
        marker.setLatLng(e.latlng);
    });
</script>

<script>
    function Sensor(
        id,
        name,
        unit,
        resolution,
        entity_address,
        active
    ) {
        this.id = id;
        this.name = name;
        this.unit = unit;
        this.resolution = resolution
        this.entity_address = entity_address;
        this.url = `/sensors/${id}`;
    }

    $(document).ready(function () {
      let unit = "";
      // Initialize the DataTable
      const table = $("#sensorsTable").dataTable({
        order: [[0, "asc"]],
        pageLength: 5,
        lengthMenu: [5, 10, 25, 50, 75, 100],
        serverSide: true,
        // make the table row vertically aligned with header
        columns: [
          { data: "id", title: "ID", orderable: true },
          { data: "name", title: "Name", orderable: true },
          { data: "unit", title: "Unit", orderable: false },
          { data: "resolution", title: "Resolution", orderable: true },
          { data: "entity_address", title: "Entity address", orderable: false },
          { data: "url", title: "URL", className: "d-none" },
        ],
  
        ajax: function (data, callback, settings) {
            const basePath = window.location.origin;
            let filter = data["search"]["value"];
            let orderColumnIndex = data["order"][0]["column"]
            let orderDirection = data["order"][0]["dir"];
            let orderColumnName = data["columns"][orderColumnIndex]["data"];

            let url = `${basePath}/api/v3_0/assets/{{asset.id}}/sensors?page=${
                data["start"] / data["length"] + 1
            }&per_page=${data["length"]}`;
    
            if (orderColumnName){
                url = `${url}&sort_by=${orderColumnName}&sort_dir=${orderDirection}`;
            }
            
            if (filter.length > 0) {
                url = `${url}&filter=${filter}`;
            }

            if (unit !== "") {
                url = `${url}&unit=${unit}`;
            }

            
  
            $.ajax({
                type: "get",
                url: url,
                success: function (response, text) {
                let clean_response = [];
                response["data"].forEach((element) =>
                    clean_response.push(
                    new Sensor(
                        element["id"],
                        element["name"],
                        element["unit"],
                        element["event_resolution"],
                        element["entity_address"],
                        element["active"]
                    )
                    )
                );
    
                callback({
                    data: clean_response,
                    recordsTotal: response["num-records"],
                    recordsFiltered: response["filtered-records"],
                });
                },
                error: function (request, status, error) {
                console.log("Error: ", error);
                },
            });
        },
      });
  
  
      // Event listener for the select box
      $("#unitFilterOptions").change(function () {
        unit = this.value;
        table.api().ajax.reload();
      });
    });
</script>

{% block paginate_tables_script %} {{ super() }} {% endblock %}
{% endblock %}
