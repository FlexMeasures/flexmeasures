{% extends "base.html" %} {% set active_page = "users" %} {% block title %} User
listing {% endblock %} {% block divs %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8">
      <div class="card">
        <h3>All {% if not include_inactive %}active {% endif %}users</h3>
        <form
          class="form-inline float-right"
          role="form"
          target=""
          method="get"
          id="user-list-options"
        >
          <div class="form-check form-check-inline">
            <label class="form-check-label">
              <input
                name="include_inactive"
                {%
                if
                include_inactive
                %}
                checked="checked"
                {%
                endif
                %}
                type="checkbox"
              />
              Include inactive
            </label>
          </div>
        </form>
        <div class="table-responsive">
          <table
            class="table table-striped table-responsive paginate nav-on-click"
            title="View this user"
          >
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Account</th>
                <th>Timezone</th>
                <th>Last Login</th>
                <th>Last Seen</th>
                <th>Active</th>
                <th class="d-none">URL</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Dynamic rows will be rendered here -->
            </tbody>
          </table>
        </div>
        <nav aria-label="Page navigation">
          <ul class="pagination" id="pagination-controls">
            <!-- Pagination buttons will be rendered here -->
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<script>
  const basePath = window.location.origin;
  const apiUrl = basePath + "/api/v3_0/users";
  const tableBody = document.getElementById("users-table-body");
  const paginationControls = document.getElementById("pagination-controls");
  let currentPage = 1;

  async function fetchUsers(page = 1) {
    try {
      const response = await fetch(`${apiUrl}?page=${page}&per_page=10`);
      const data = await response.json();

      renderTable(data.users, tableBody);
      renderPagination(data.total_pages, page);
    } catch (error) {
      console.error("Error fetching users:", error);
    }
  }

  function renderPagination(totalPages, currentPage) {
    // Clear existing pagination
    paginationControls.innerHTML = "";

    let paginationHTML = "";

    // Previous Button (disabled if on the first page)
    paginationHTML += `
      <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
        <a class="page-link" href="javascript:void(0)" onclick="changePage(${
          currentPage - 1
        })">Previous</a>
      </li>
    `;

    // Page Buttons
    for (let page = 1; page <= totalPages; page++) {
      const isActive = page === currentPage ? "active" : "";
      const activeStyle =
        page === currentPage
          ? "background-color: {{primary_color}}; color: #fff"
          : "color: {{primary_color}}";

      paginationHTML += `
        <li class="page-item ${isActive}">
          <a class="page-link" style="${activeStyle}" href="javascript:void(0)" onclick="changePage(${page})">${page}</a>
        </li>
      `;
    }

    // Next Button (disabled if on the last page)
    paginationHTML += `
      <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
        <a class="page-link" href="javascript:void(0)" onclick="changePage(${
          currentPage + 1
        })">Next</a>
      </li>
    `;

    // Insert all at once
    paginationControls.innerHTML = paginationHTML;
  }

  function changePage(page) {
    currentPage = page;
    fetchUsers(page);
  }

  // Initial fetch
  fetchUsers(currentPage);
</script>

{% block paginate_tables_script %} {{ super() }} {% endblock %} {% endblock%}
