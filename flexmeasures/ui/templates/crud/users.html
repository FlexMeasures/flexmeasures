{% extends "base.html" %} {% set active_page = "users" %} {% block title %} User
listing {% endblock %} {% block divs %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8">
      <div class="card">
        <h3>All {% if not include_inactive %}active {% endif %}users</h3>
        <form
          class="form-inline float-right"
          role="form"
          target=""
          method="get"
          id="user-list-options"
        >
          <div class="form-check form-check-inline">
            <label class="form-check-label">
              <input
                name="include_inactive"
                {%
                if
                include_inactive
                %}
                checked="checked"
                {%
                endif
                %}
                type="checkbox"
              />
              Include inactive
            </label>
          </div>
        </form>
        <div class="table-responsive">
          <table
            class="table table-striped table-responsive paginate nav-on-click"
            title="View/edit this user"
          >
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Roles</th>
                <th>Account</th>
                <th>Timezone</th>
                <th>Last Login</th>
                <th>Last Seen</th>
                <th>Active</th>
                <th class="d-none">URL</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <!-- Dynamic rows will be rendered here -->
            </tbody>
          </table>
        </div>

        <nav aria-label="Page navigation example">
          <ul class="pagination" id="pagination-controls">
            <!-- Pagination buttons will be rendred here -->
          </ul>
        </nav>
      </div>
    </div>
    <div class="col-md-2"></div>
  </div>
</div>

<script>
  const basePath = window.location.origin;
  const apiUrl = basePath + "/api/v3_0/users"; // Update with your actual API endpoint
  const tableBody = document.getElementById("users-table-body");
  const paginationControls = document.getElementById("pagination-controls");
  let currentPage = 1;

  async function fetchUsers(page = 1) {
    try {
      const response = await fetch(`${apiUrl}?page=${page}&per_page=1`);
      const data = await response.json();

      renderTable(data.users);
      renderPagination(data.totalPages, page);
    } catch (error) {
      console.error("Error fetching accounts:", error);
    }
  }

  function renderTable(users) {
    tableBody.innerHTML = "";

    users.forEach((user) => {
      const row = `
                <tr>
                    <td>${user.username}</td>
                    <td>
                      <a href="mailto:${user.email}" title="Mail this user">${user.email}</a>
                    </td>
                    <td>
                      ${user.flexmeasures_roles.join(", ")}
                    </td>
                     <td>
                        <a href="/accounts/${
                          user.account.id
                        }" title="View accounts">${user.account.name}</a>
                    </td>
                    <td>
                        ${user.timezone}
                    </td>
                    <td title="${
                      user.last_login_at
                    }" data-sort="${user.last_login_at}">
                        ${user.last_login_at }
                    </td>
                    <td title="${
                      user.last_seen_at
                    }" data-sort="${user.last_seen_at}">
                        ${user.last_seen_at }
                    </td>
                    <td>
                        ${user.active}
                    </td>
                    <td class="d-none">/users/${user.id}</td>
                </tr>
            `;
      tableBody.insertAdjacentHTML("beforeend", row);
    });
  }

  function renderPagination(totalPages, currentPage) {
    paginationControls.innerHTML = "";

    for (let page = 1; page <= totalPages; page++) {
      const isActive = page === currentPage ? "" : "";
      const activeStyle =
        page === currentPage
          ? "background-color: {{primary_color}}; color: #fff"
          : "color: {{primary_color}}";
      const button = `
                <li class="page-item ${isActive}">
                    <a class="page-link" style="${activeStyle}"" href="#" onclick="changePage(${page})">${page}</a>
                </li>
            `;
      paginationControls.insertAdjacentHTML("beforeend", button);
    }
  }

  function changePage(page) {
    currentPage = page;
    fetchUsers(page);
  }

  // Initial fetch
  fetchUsers(currentPage);
</script>

{% block paginate_tables_script %} {{ super() }} {% endblock %} {% endblock%}
