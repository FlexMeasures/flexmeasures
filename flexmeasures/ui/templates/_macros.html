{% macro show_tree(assets, current_asset_name) %}
  <div class="container">
    <div id="view"></div>
    <!-- Bootstrap Modal -->
    <div class="modal fade" id="nodeModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Node Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table id="modalTable" class="table table-bordered">
              <thead id="modalTableHead"></thead>
              <tbody id="modalTableBody"></tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>


<script type="text/javascript">
  window.onload = function(){

  let assets = {{ assets | safe }};
  let currentAssetName = '{{ current_asset_name | safe}}';

  {# Vega Spec adapted from https://stackoverflow.com/a/76300309 #}


treeSpecs = {
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 1000,
  "height": 650,
  "padding": 0,
  "autosize": {"type": "fit", "resize": true},
  "signals": [
    {"name": "nodeWidth", "value": 190},
    {"name": "nodeHeight", "value": 40},
    {"name": "verticalNodeGap", "value": 10},
    {"name": "horizontalNodeGap", "value": 60},
    {"name": "currentAssetName", "value": currentAssetName},
    {
      "name": "scaledNodeHeight",
      "update": "abs(nodeHeight/ max(span(ydom),height))*height"
    },
    {"name": "scaledNodeWidth", "update": "(nodeWidth/ span(xdom))*width"},
    {"name": "xrange", "update": "[0, width]"},
    {"name": "yrange", "update": "[0, height]"},
    {"name": "scaledFont13", "update": "(20/ span(xdom))*width"},
    {"name": "scaledLimit", "update": "(20/ span(xdom))*width"},
    {
      "name": "xdom",
      "update": "slice(xext)",
    },
    {
      "name": "ydom",
      "update": "slice(yext)",
    },
    {
      "name": "node_click",
      "value": null,
      "on": [
        {
          "events": "click",
          "update": "datum"
        }
      ]
    },
  ],
  "data": [
    {
      "name": "tree",
      "values": assets,
      "transform": [
        {"type": "stratify", "key": "id", "parentKey": "parent"},
        {
          "type": "tree",
          "method": "tidy",
          "size": [{"signal": "nodeHeight *0.1"},
                   {"signal": "width"}
          ],
          "separation": {"signal": "true"},
          "nodeSize" : [
            {"signal": "nodeHeight+verticalNodeGap"},
            {"signal": "nodeWidth+horizontalNodeGap"}

        ],
          "as": ["y", "x", "depth", "children"],
        },
        {"type": "extent", "field": "x", "signal": "xext"},
        {"type": "extent", "field": "y", "signal": "yext"}
      ]
    },
    {
      "name": "links",
      "source": "tree",
      "transform": [
        {"type": "treelinks", "signal": "upstream"},
        {
          "type": "linkpath",
          "orient": "horizontal",
          "shape": {"signal": "'diagonal'"},
          "sourceY": {"expr": "scale('yscale', datum.source.y)"},
          "sourceX": {"expr": "scale('xscale', datum.source.x)"},
          "targetY": {"expr": "scale('yscale', datum.target.y)"},
          "targetX": {"expr": "scale('xscale', datum.target.x)"}
        }
      ]
    }
  ],
  "scales": [
    {
      "name": "xscale",
      "zero": false,
      "domain": {"signal": "xdom"},
      "range": {"signal": "xrange"}
    },
    {
      "name": "yscale",
      "zero": false,
      "domain": {"signal": "ydom"},
      "range": {"signal": "yrange"}
    }
  ],
  "marks": [
    {
      "type": "path",
      "from": {"data": "links"},
      "encode": {
        "update": {"path": {"field": "path"}, "stroke": {"value": "#aaa"}}
      }
    },
    {
      "name": "node",
      "description": "The Parent Node",
      "type": "group",
      "clip": false,
      "from": {"data": "tree"},
      "encode": {
        "update": {
          "x": {"field": "x", "scale": "xscale"},
          "width": {
            "signal": "datum.name === currentAssetName ? scaledNodeWidth * 1.1 : scaledNodeWidth"
          },
          "yc": {"field": "y", "scale": "yscale"},
          "height": {
            "signal": "datum.name === currentAssetName ? scaledNodeHeight * 1.1 : scaledNodeHeight"
          },
          "fill": {
            "signal": "datum.name === currentAssetName ? 'gold' : 'lightblue'"
          },
          "stroke": {
            "signal": "datum.name === currentAssetName ? 'darkorange' : 'black'"
          },
          "strokeWidth": {
            "signal": "datum.name === currentAssetName ? 4 : 1"
          },
          "cornerRadius": {"value": 5},
          "on": [
            {
              "events": "click",
              "update": "datum"
            }
          ],
          "tooltip": {"signal": "datum.tooltip"}
        }
      },
      "marks": [
        {
          "type": "text",
          "interactive": false,
          "name": "name",
          "encode": {
            "update": {
              "x": {"signal": "(5/ span(xdom))*width"},
              "y": {"signal": "(3/ span(xdom))*width"},
              "fontWeight": {"value": "bold"},
              "baseline": {"value": "top"},
              "text": {"signal": "parent.name"},
              "fontSize": {
                "signal": "datum.name === currentAssetName ? scaledFont13 * 1.5 : scaledFont13"
              },
              "fill": {
                "signal": "datum.name === currentAssetName ? 'black' : 'darkblue'"
              },
              "limit": {"signal": "scaledNodeWidth-scaledLimit"},
              "font": {"value": "Calibri"},
              "on": [
                {
                  "events": "click",
                  "update": "datum"
                }
              ],
              "tooltip": {"signal": "parent.tooltip"}
            }
          }
        },
      ]
    }
  ]
}
vegaEmbed("#view", treeSpecs, { renderer: "svg" }).then(function(result) {
  result.view.addSignalListener("node_click", function(name, value) {
    if (value) {
      openModal(value);
    }
  });
});

function openModal(data) {
  document.getElementById("modalTitle").innerText = "Sensors for " + data.name;
  let tableHead = document.getElementById("modalTableHead");
  let tableBody = document.getElementById("modalTableBody");

  // Clear previous content
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  if (data.sensors && data.sensors.length > 0) {
    let keys = Object.keys(data.sensors[0]); // e.g., ['name', 'unit']
    
    // Create table header row
    let headerRow = document.createElement("tr");
    keys.forEach(key => {
      let headerText = key.charAt(0).toUpperCase() + key.slice(1);
      let th = document.createElement("th"); // Use <th> for header cells
      th.innerText = headerText;
      th.setAttribute("aria-label", headerText); // set aria-label so floatThead can pick it up
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    // Force destroy the floatThead instance
    setTimeout(function(){
      if ($.fn.floatThead) {
        $('#modalTable').floatThead('destroy');
      }
    }, 200);

    // Populate table with sensor data
    data.sensors.forEach(sensor => {
      let row = document.createElement("tr");
      keys.forEach(key => {
        let td = document.createElement("td");
        td.innerText = sensor[key] !== undefined ? sensor[key] : "N/A"; // Handle undefined values
        row.appendChild(td);
      });
      tableBody.appendChild(row);
    });
  } else {
    tableBody.innerHTML = "<tr><td colspan='100%'>No sensor data available</td></tr>";
  }

  // Show Bootstrap modal
  let modal = new bootstrap.Modal(document.getElementById('nodeModal'));
  modal.show();
}
}
  </script>
{% endmacro %}