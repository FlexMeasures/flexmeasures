{% extends "base.html" %} 
{% set active_page = "users" %} 
{% block title %} User listing {% endblock %} 
{% block divs %}

<div class="container-fluid">
  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-9">
      <div class="card">

        <div class="d-flex justify-content-between align-items-center">
          <h3 id="usersTableTitle">All users</h3>
        
          <a class="btn bg-primary-custom text-decoration-none text-light" data-bs-toggle="modal"
            data-bs-target="#createUserModal">
            Create User
          </a>
        </div>

        <div class="form-check form-check-inline">
          <label class="form-check-label">
            <input
              id="inactiveUsersCheckbox"
              name="include_inactive"
              type="checkbox"
            />
            Include inactive
          </label>
        </div>
        <div class="table-responsive">
          <table
            class="table table-striped paginate nav-on-click"
            title="View this asset"
            id="usersTable"
          ></table>
        </div>

      </div>
    </div>
  </div>
</div>


 <!-- Create User Modal -->
<div class="modal fade " id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title pe-2">Create User</h5>
        <div class="dropdown" data-bs-auto-close="outside">
          <span class="fa fa-info dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false"
            rel="tooltip" aria-hidden="true" tabindex="0" data-bs-placement="right"></span>

          <div class="dropdown-menu p-3" style="width: 400px;">
            <div>
              <strong>Help</strong>
              <p class="mb-2 pt-2">
                This modal allows you to create a new user.
              </p>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form id="createUserForm">
          <div class="mb-3">
            <label for="account" class="form-label">Account</label>
            <select class="form-select" id="account" name="account">
              <option value="">Select an account</option>
              {% for account in accounts %}
                <option value="{{ account.id }}">{{ account.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" required>
            <small class="text-muted">
              Your email will be used as the initial password. The user can change it after logging in.
            </small>
          </div>

          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $(document).ready(function () {
    // Handle form submission
    $("#createUserForm").submit(function (event) {
      event.preventDefault();

      const username = $("#username").val();
      const email = $("#email").val();
      const account_id = $("#account").val();

      if (!username || !email) {
        showToast("Username and Email are required.", 'error');
        return;
      }

      $.ajax({
        type: "POST",
        url: "/api/v3_0/users",
        data: JSON.stringify({ username, email, account_id }),
        contentType: "application/json",
        success: function (response) {
          $("#createUserModal").modal("hide");
          $("#createUserForm")[0].reset();
          $("#usersTable").DataTable().ajax.reload();

          showToast(
            `User <i class='fw-bold'>${username}</i> created successfully!`,
            'success'
          );
        },
        error: function (xhr, status, error) {
          console.error("Error creating user:", error);
          showToast(
            "Failed to create user. Please try again.", 'error'
          );
        }
      });
    });
  });
</script>

<script>
   function User(
      id,
      username,
      email,
      roles,
      account,
      timezone,
      lastLogin,
      lastSeen,
      active
   ) {
      this.id = id;
      this.username = `<span>${username}</span>`;
      this.email = `<a href="mailto:${email}" title="Mail this user">${email}</a>`;
      this.roles = roles.map((role) => role).join(", ");
      this.url = `/users/${id}`;

      if (account == null) this.account = "PUBLIC";
      else
         this.account = `
                <a href="/accounts/${account["id"]}" title="View this account">${account["name"]}</a>
              `;
      this.timezone = timezone;
      this.lastLogin = lastLogin;
      this.lastSeen = lastSeen;
      this.active = active;
   }

  $(document).ready(function () {
    let includeInactive = false;
    const tableTitle = $("#usersTableTitle");
    // Initialize the DataTable
    const table = $("#usersTable").dataTable({
        order: [
          [0, "asc"]
        ],
        serverSide: true,
        // make the table row vertically aligned with header
        columns: [{
              data: "username",
              title: "Username",
              orderable: true
          },
          {
              data: "email",
              title: "Email",
              orderable: true
          },
          {
              data: "roles",
              title: "Roles",
              orderable: false
          },
          {
              data: "account",
              title: "Account",
              orderable: false
          },
          {
              data: "timezone",
              title: "Timezone",
              orderable: false
          },
          {
              data: "lastLogin",
              title: "Last login",
              orderable: true
          },
          {
              data: "lastSeen",
              title: "Last seen",
              orderable: true
          },
          {
              data: "active",
              title: "Active",
              orderable: false
          },
          {
              data: "url",
              title: "URL",
              className: "d-none"
          },
        ],

        ajax: function (data, callback, settings) {

          const basePath = window.location.origin;
          let filter = data["search"]["value"];
          let orderColumnIndex = data["order"][0]["column"]
          let orderDirection = data["order"][0]["dir"];
          let orderColumnName = data["columns"][orderColumnIndex]["data"];

          let url = `${basePath}/api/v3_0/users?page=${data["start"] / data["length"] + 1}&per_page=${data["length"]}&include_inactive=${includeInactive}`;

          if (filter.length > 0) {
              url = `${url}&filter=${filter}`;
          }

          if (orderColumnName) {
              url = `${url}&sort_by=${orderColumnName}&sort_dir=${orderDirection}`;
          }

          $.ajax({
              type: "get",
              url: url,
              success: function (response, text) {
                let clean_response = [];
                response["data"].forEach((element) =>
                    clean_response.push(
                      new User(
                          element["id"],
                          element["username"],
                          element["email"],
                          element["flexmeasures_roles"],
                          element["account"],
                          element["timezone"],
                          element["last_login_at"],
                          element["last_seen_at"],
                          element["active"]
                      )
                    )
                );

                callback({
                    data: clean_response,
                    recordsTotal: response["num-records"],
                    recordsFiltered: response["filtered-records"],
                });
              },
              error: function (request, status, error) {
                console.log("Error: ", error);
              },
          });
        },
    });


    // Event listener for the checkbox to toggle includeInactive state
    $("#inactiveUsersCheckbox").change(function () {
        includeInactive = this.checked;
        table.api().ajax.reload();
        if (!includeInactive) {
          tableTitle.text("All users");
        } else {
          tableTitle.text("All active users");
        }
    });
  }); 
</script>
{% block paginate_tables_script %} {{ super() }} {% endblock %} {% endblock%}
