name: lint-and-test

on: push


jobs:
  test:
    runs-on: ubuntu-latest
    #strategy:  # TODO: make work with pre-commit
    #  matrix:
    #    python-version: [ '3.8', '3.6' ]
    name: Test (on Python3.8)
    steps:
      - uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - uses: actions/checkout@v2
      - uses: pre-commit/action@v2.0.0
      - name: Setup Postgres database
        uses: Daniel-Marynicz/postgresql-action@master
        with:
          postgres_image_tag: 12-alpine
          app_user: flexmeasures_test
          app_user_password: flexmeasures_test
          app_db: flexmeasures_test
          postgres_extensions: cube,earthdistance    
      - run: make install-for-dev
      - run: mkdir -p ./instance
      - run: head -c 24 /dev/urandom > ./instance/secret_key
      - name: Run tests
        run: make test
        env:
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432

    #services:
    #  # Label used to access the service container
    #  postgres:
    #    # Docker Hub image
    #    image: postgres:12.5 
    #    env:
    #      POSTGRES_USER: flexmeasures_test
    #      POSTGRES_PASSWORD: flexmeasures_test
    #      POSTGRES_DB: flexmeasures_test
    #    ports:
    #      - 5432:5432
    #    # Set health checks to wait until postgres has started
    #    options: >-
    #      -e POSTGRES_EXTENSIONS=cube,earthdistance
    #      --health-cmd pg_isready
    #      --health-interval 10s
    #      --health-timeout 5s
    #      --health-retries 5
